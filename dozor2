# -*- coding: utf-8 -*-
import telepot, time, sys, random, os, json
from pprint import pprint

BOT_TOKEN = "178002319:AAE8RLeChZH8uEPT5ooeJ-N4IsD0ZwUrmFA"
SECRET_WORD = u"TESTWORD"
SECRET_CODES = [u'TE', u'ST', u'WO', u'RD']
SECRET_COUNT = len(SECRET_CODES)
BAD_MSG = "Код не принят"
GOOD_MSG = "Код принят"
START_MSG = "Внимание, команды! Квест начался! Время пошло!"
teams = []
timer = 0



class Team:
    def __init__(self, name, user_id):
        self.name = name
        self.owner_id = user_id
        self.solved = 0
        self.list_of_codes = SECRET_CODES
        self.is_word = False
        self.has_ended = False


def start_quest():
    for t in teams:
        bot.sendMessage(t.owner_id, START_MSG)

    pass


def find_team(user_id):
    for t in teams:
        if user_id == t.owner_id:
            return t
    return False


def check_code(team, code, user_id):
    if not team.is_word:
            if code.upper() in team.list_of_codes:
                bot.sendMessage(user_id, code + ' ' + GOOD_MSG)
                team.solved += 1
                team.list_of_codes.remove(code)
                if team.solved == SECRET_COUNT:
                    team.is_word = True
                    bot.sendMessage(user_id, 'Введите полное кодовое слово:')
            else:
                bot.sendMessage(user_id, BAD_MSG)
    else:
        if code != SECRET_WORD:
            bot.sendMessage(user_id, BAD_MSG)
        else:
            bot.sendMessage(user_id, "Поздравляем, вы прошли квест!")



def register_team(user_id, team_name):
    bot.sendMessage(user_id, "Success!")
    newteam = Team(team_name, user_id)
    teams.append(newteam)
    fTeams.truncate(0)
    fTeams.write(json.dumps(teams))
    fTeams.flush()


def is_registered(user_id):
    for t in teams:
        if t.owner_id == user_id:
            return True
    return False


def print_teams(user):
    message = [t.name.decode('unicode_escape') for t in teams]
    bot.sendMessage(user["id"], message)


def handle_message(msg):
    try: 
        user = msg["from"]
        pprint(msg)
        text = msg["text"].split()
        current_team = find_team(user['id'])
        if "/" in text[0]:
            if text[0] == "/register":
                if len(text) == 2:
                    register_team(user['id'], text[0])
                else:
                    bot.sendMessage(user["id"], "Пожалуйста, введите /register и название своей команды!")
            elif text[0] == "/status":
                pass
            elif text[0] == "/teams":
                print_teams(user)
            elif text[0] == "/start":
                start_quest()
        elif is_registered(user['id']):
            check_code(curren_tteam, text[0], user['id'])
        else:
            bot.sendMessage(user['id'], 'Вы не зарегестрированы на квест!')
    except Error(e):
        print e


#====================MAIN=============================#


f = open("ReceivedMessages.log", 'w')
fTeams = open("RegisteredTeams.json", 'r+')

teams = json.loads(fTeams.readline())

bot = telepot.Bot(BOT_TOKEN)
bot.message_loop(handle_message)
print 'Listening...'

while 1:
    time.sleep(10)

f.close()
fTeams.close()
 
